/*
 * NOTE: When minifying, be sure to transpile ES6 code down to ES5
 */
(function(b,d){'use strict';window.tchat={currentChannel:{id:null},notifs:!1},window.tchat.channel=function(f,g){function i(v){(13===v.which||13===v.keyCode)&&''!==p.value&&(firebase.auth().currentUser?k(p.value):d.toast('You\u2019re not logged in. Log in to send chats.',3e3),p.value='')}function j(v){return v.replace(/[<>]/g,function(w){return{'<':'&lt;','>':'&gt;'}[w]})}function k(v){var y=firebase.database().ref().child('chat/channels/'+tchat.currentChannel.id),z=y.child('msgs'),x={edited:!1,from:firebase.auth().currentUser.uid,msg:v,timestamp:+Date.now()};z.push().set(x),m()}function l(v){var w=/[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?/gi,x=/\b_(\S[\s\S]*?)_\b/gi,y=/\*\b(\S[\s\S]*?)\b\*/gi,z=v.msg,A=firebase.database().ref('/users/'+v.from);return v.msg=j(v.msg),v.msg=v.msg.replace(w,function(B){var C=document.createElement('a'),D=!!(B.startsWith('http://')||B.startsWith('https://'));return C.href=D?B:'//'+B,C.innerHTML=B,C.target='_blank',C.outerHTML}),v.msg=v.msg.replace(x,function(B,C){var D=document.createElement('em');return D.innerHTML=C,D.outerHTML}),v.msg=v.msg.replace(y,function(B,C){var D=document.createElement('strong');return D.innerHTML=C,D.outerHTML}),A.once('value').then(function(B){var C=B.val(),D={name:C.username,msg:v.msg,user:C,data:v,raw:z};return D}).then(function(B){var C=+B.data.timestamp>+tchat.loadedTime;return!document.hasFocus()&&!0===tchat.notifs&&C&&navigator.serviceWorker.ready.then(function(D){D.showNotification(B.name||'New message',{body:z,icon:B.user.photo,badge:'https://benji.pw/assets/icons/t.png',vibrate:[100,150,100],data:{id:'tchat',url:'https://benji.pw/tchat/'}})}),B.name+': '+B.msg+''})}function m(){if(document.getElementById('tchat').classList.contains('active')){var v=document.getElementsByClassName('chat-container')[0];v.scrollTop=v.scrollHeight}}tchat.currentChannel.id=f.toLowerCase();var n=document.getElementById('tchat'),o=n.querySelector('[data-tchat="messageContainer"]'),p=n.querySelector('input[data-tchat="input"]'),q=n.querySelector('[data-tchat="chName"]'),r=firebase.database().ref().child('chat/channels/'+tchat.currentChannel.id),t=r.child('msgs').orderByKey();!0===g&&d.toast('Switching to channel '+tchat.currentChannel.id+'&hellip;',1500),o.innerHTML='',p.removeEventListener('keypress',i),r.off('value'),t.off('child_added'),t.off('child_changed'),t.off('child_removed'),r.on('value',function(v){var w=v.val();try{q.innerText=w.meta.name}catch(x){return d.toast('That\u2019s not a valid channel. Switching to global&hellip;',3e3),void tchat.channel('global')}}),t.on('child_added',function(v){var w=document.createElement('li'),x=v.val();w.id='msg'+v.key,o.appendChild(w),l(x).then(function(y){w.innerHTML=y,m()})}),t.on('child_changed',function(v){var w=document.getElementById('msg'+v.key),x=v.val();l(x).then(function(y){w.innerHTML=y})}),t.on('child_removed',function(v){var w=document.getElementById('msg'+v.key);w&&w.remove()}),p.addEventListener('keypress',i),b(document).ready(function(){b('ul.tabs').tabs({onShow:m})})},tchat.channel('global',!1)})(jQuery,Materialize);
